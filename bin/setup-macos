#!/bin/bash

# snapCloud install script for macOS
# contributed by Michael Ball

print_ok() {
   echo -e "\033[32m$1\033[0m"
}

print_warning() {
    echo -e "\033[33m$1\033[0m"
}

# Ensure brew is installed.
if [[ -z `which brew` ]]; then
    echo 'Please install homebrew before continuing.';
    echo 'Visit brew.sh for instructions.';
    exit 1;
fi

if [[ -z `which npm` ]]; then
    echo 'Skipping installing sass (css) maildev (an email catcher).'
    echo 'To install, first install node (npm), then do:'
    echo '"npm install -g sass maildev"'
else
    print_ok 'Installing dependecies from package.json ...'
    npm install
fi

# As of 2025 lua 5.1 is no longer in homebrew
# We will use the package manager mise to install lua.
print_ok 'Installing lua and postgres'
brew install mise luarocks postgres pcre gcc@12

print_ok 'Using mise to install lua 5.1'
mise install lua@5.1
# Set lua 5.1 as the default version
mise default -g lua@5.1

print_ok 'Installing OpenResty'
print_warning 'NOTE: The dependency "libmaxminddb" may not install properly. We do not need it'
print_warning "If you run into an issue, use `brew edit openresty` to file the install script"
print_warning 'and remove the line that installs libmaxminddb, as well as --with-http-geoip-module'
brew install openresty/brew/openresty


print_ok "Setting Git to use https:// instead of unsecured git:// for GitHub"
git config --global url."https://github".insteadOf git://github

print_ok "Installing Lapis & Lua Dependencies"
make install

# NOTE: As of 2025 - when lua 5.1 is not in brew, this needs to be revisited.
print_ok 'Adding luarocks path info to bashrc'
echo "" >> ~/.bashrc
echo "# Luarocks 3 and Lua 5.1 tools (added by snapCloud)." >> ~/.bashrc
echo $(luarocks path --lua-version 5.1) >> ~/.bashrc

print_ok "Prerequisites installed."
print_ok "Setting up postgres database."

export LAPIS_ENVIRONMENT=development
bin/lapis-migrate

# print_ok "Please follow all instructions after 'Setting up the database' in INSTALL.md"
